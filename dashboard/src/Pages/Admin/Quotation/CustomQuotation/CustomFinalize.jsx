import React, { useState, useEffect } from "react";
import {
  Box,
  Grid,
  Typography,
  Button,
  Card,
  CardContent,
  Dialog,
  DialogTitle,
  DialogContent,
  DialogActions,
  Table,
  TableBody,
  TableCell,
  TableContainer,
  TextField,
  TableHead,
  TableRow,
  Paper,
  List,
  ListItem,
  ListItemText,
  Chip,
  Accordion,
  AccordionSummary,
  AccordionDetails,
  IconButton,
  CircularProgress,
  Snackbar,
  Alert,
} from "@mui/material";
import {
  FormatQuote as FormatQuoteIcon,
  Payment,
  Phone,
  AlternateEmail,
  CreditCard,
  Description,
  Person,
  LocationOn,
  CalendarToday,
  CheckCircle,
  Cancel,
  Warning,
  Business,
  Language,
  ExpandMore,
  Edit,
  Group,
  Receipt,
  Route,
  Route as RouteIcon,
  Visibility,
  AddCircleOutline,
  Image as ImageIcon,
  FormatQuote,
  Delete,
  Add,
} from "@mui/icons-material";
import { useParams } from "react-router-dom";
import { useDispatch, useSelector } from "react-redux";

import EmailQuotationDialog from "../VehicleQuotation/Dialog/EmailQuotationDialog";
import MakePaymentDialog from "../VehicleQuotation/Dialog/MakePaymentDialog";
import FinalizeDialog from "./Dialog/FinalizeDialog";
import HotelVendorDialog from "./Dialog/HotelVendor";
import AddBankDialog from "../VehicleQuotation/Dialog/AddBankDialog";
import EditDialog from "../VehicleQuotation/Dialog/EditDialog";
import AddServiceDialog from "../VehicleQuotation/Dialog/AddServiceDialog";
import AddFlightDialog from "../HotelQuotation/Dialog/FlightDialog";
import { getCustomQuotationById } from "../../../../features/quotation/customQuotationSlice";

// Transaction Summary Dialog Component
const TransactionSummaryDialog = ({ open, onClose }) => {
  const tableHeaders = [
    "Sr No.",
    "Receipt",
    "Invoice",
    "Party Name",
    "Transaction Remark",
    "Transaction...",
    "Dr/Cr",
    "Amount",
  ];

  return (
    <Dialog
      open={open}
      onClose={onClose}
      maxWidth="lg"
      fullWidth
      PaperProps={{ sx: { minHeight: "400px" } }}
    >
      <DialogTitle>
        <Typography variant="h6" component="div" fontWeight="bold">
          Transaction Summary
        </Typography>
      </DialogTitle>
      <DialogContent>
        <TableContainer
          component={Paper}
          variant="outlined"
          sx={{ border: "1px solid #e0e0e0" }}
        >
          <Table sx={{ minWidth: 800 }} aria-label="transaction summary table">
            <TableHead>
              <TableRow sx={{ backgroundColor: "#f5f5f5" }}>
                {tableHeaders.map((header, index) => (
                  <TableCell
                    key={index}
                    sx={{
                      fontWeight: "bold",
                      borderRight:
                        index < tableHeaders.length - 1
                          ? "1px solid #e0e0e0"
                          : "none",
                    }}
                  >
                    {header}
                  </TableCell>
                ))}
              </TableRow>
            </TableHead>
            <TableBody>
              <TableRow>
                <TableCell
                  colSpan={tableHeaders.length}
                  align="center"
                  sx={{
                    height: 120,
                    color: "text.secondary",
                    fontStyle: "italic",
                  }}
                >
                  No data
                </TableCell>
              </TableRow>
            </TableBody>
          </Table>
        </TableContainer>
      </DialogContent>
    </Dialog>
  );
};

const CustomFinalize = () => {
  const { id } = useParams();
  const dispatch = useDispatch();
  
  const { 
    selectedQuotation, 
    loading, 
    error 
  } = useSelector((state) => state.customQuotation);

  // State
  const [activeInfo, setActiveInfo] = useState(null);
  const [openFinalize, setOpenFinalize] = useState(false);
  const [openAddFlight, setOpenAddFlight] = useState(false);
  const [vendor, setVendor] = useState("");
  const [isFinalized, setIsFinalized] = useState(false);
  const [invoiceGenerated, setInvoiceGenerated] = useState(false);
  const [snackbar, setSnackbar] = useState({
    open: false,
    message: "",
    severity: "success"
  });
  const [itineraryDialog, setItineraryDialog] = useState({
    open: false,
    mode: 'add',
    day: null,
    title: "",
    description: "",
    id: null
  });

  // Initialize quotation state
  const [quotation, setQuotation] = useState({
    date: "",
    reference: "",
    actions: ["Finalize", "Add Service", "Email Quotation", "Preview PDF", "Make Payment", "Add Flight", "Transaction"],
    bannerImage: "",
    customer: {
      name: "",
      location: "",
      phone: "",
      email: "",
    },
    pickup: {
      arrival: "",
      departure: "",
    },
    hotel: {
      guests: "",
      rooms: "",
      mealPlan: "",
      destination: "",
      itinerary: "",
    },
    vehicles: [],
    pricing: { 
      discount: "", 
      gst: "", 
      total: "",
      roomCost: "",
      vehicleCost: "",
      totalCost: ""
    },
    policies: {
      inclusions: [],
      exclusions: "",
      paymentPolicy: "",
      cancellationPolicy: "",
      terms: "",
    },
    footer: {
      contact: "",
      phone: "",
      email: "",
      received: "",
      balance: "",
      company: "Iconic Yatra",
      address: "Office No 15, Bhawani Market Sec 27, Noida, Uttar Pradesh ‚Äì 201301",
      website: "https://www.iconicyatra.com",
    },
  });

  const [editDialog, setEditDialog] = useState({
    open: false,
    field: "",
    value: "",
    title: "",
    nested: false,
    nestedKey: "",
  });
  const [openAddService, setOpenAddService] = useState(false);
  const [services, setServices] = useState([]);
  const [currentService, setCurrentService] = useState({
    included: "no",
    particulars: "",
    amount: "",
    taxType: "",
  });
  const [openEmailDialog, setOpenEmailDialog] = useState(false);
  const [openPaymentDialog, setOpenPaymentDialog] = useState(false);
  const [openBankDialog, setOpenBankDialog] = useState(false);
  const [flights, setFlights] = useState([]);
  const [openAddBankDialog, setOpenAddBankDialog] = useState(false);
  const [openTransactionDialog, setOpenTransactionDialog] = useState(false);
  const [days, setDays] = useState([]);
  const [accountType, setAccountType] = useState("company");
  const [accountName, setAccountName] = useState("Iconic Yatra");
  const [accountNumber, setAccountNumber] = useState("");
  const [ifscCode, setIfscCode] = useState("");
  const [bankName, setBankName] = useState("");
  const [branchName, setBranchName] = useState("");
  const [newBankDetails, setNewBankDetails] = useState({
    bankName: "",
    branchName: "",
    accountHolderName: "",
    accountNumber: "",
    ifscCode: "",
    openingBalance: "",
  });
  const [accountOptions, setAccountOptions] = useState([
    { value: "Cash", label: "Cash" },
    { value: "KOTAK Bank", label: "KOTAK Bank" },
    { value: "YES Bank", label: "YES Bank" },
  ]);

  // Safe data access helper function
  const safeGet = (obj, path, defaultValue = '') => {
    try {
      const value = path.split('.').reduce((current, key) => {
        return current && current[key] !== undefined ? current[key] : undefined;
      }, obj);
      return value !== undefined ? value : defaultValue;
    } catch (error) {
      console.warn(`Error accessing path ${path}:`, error);
      return defaultValue;
    }
  };

  // Fetch quotation data on component mount
  useEffect(() => {
    if (id) {
      dispatch(getCustomQuotationById(id));
    }
  }, [dispatch, id]);

  // Update local state when API data is loaded
  useEffect(() => {
    if (selectedQuotation && selectedQuotation.data) {
      const apiData = selectedQuotation.data;
      
      console.log('API Data received:', apiData);

      // Extract all data from API response
      const tourDetails = safeGet(apiData, 'tourDetails', {});
      const quotationDetails = safeGet(tourDetails, 'quotationDetails', {});
      const clientDetails = safeGet(apiData, 'clientDetails', {});
      const vehicleDetails = safeGet(tourDetails, 'vehicleDetails', {});
      const policies = safeGet(tourDetails, 'policies', {});
      const destinations = safeGet(quotationDetails, 'destinations', []);
      const rooms = safeGet(quotationDetails, 'rooms', {});
      const taxes = safeGet(quotationDetails, 'taxes', {});
      const pickupDrop = safeGet(apiData, 'pickupDrop', []);

      // Calculate pricing
      const roomCost = calculateRoomCost(destinations, rooms);
      const vehicleCost = safeGet(vehicleDetails, 'costDetails.totalCost', 0);
      const totalCost = parseFloat(roomCost) + parseFloat(vehicleCost);
      const gstAmount = taxes.applyGST ? totalCost * 0.18 : 0;
      const finalTotal = totalCost + gstAmount;

      // Format itinerary days
      const itineraryData = safeGet(tourDetails, 'itinerary', []);
      const formattedDays = itineraryData.map((item, index) => ({
        id: safeGet(item, '_id', index + 1),
        date: formatDate(safeGet(item, 'date')) || `Day ${index + 1}`,
        title: safeGet(item, 'dayTitle', `Day ${index + 1}`),
        description: safeGet(item, 'dayNote', ''),
        image: safeGet(item, 'image', null)
      }));

      // Update quotation state with API data
      setQuotation({
        date: formatDate(safeGet(apiData, 'createdAt')),
        reference: safeGet(apiData, 'quotationId'),
        actions: ["Finalize", "Add Service", "Email Quotation", "Preview PDF", "Make Payment", "Add Flight", "Transaction"],
        bannerImage: safeGet(tourDetails, 'bannerImage', ''),
        customer: {
          name: safeGet(clientDetails, 'clientName'),
          location: safeGet(clientDetails, 'sector'),
          phone: "+91 7053900957", // Default as not in API
          email: "client@example.com", // Default as not in API
        },
        pickup: {
          arrival: `Arrival: ${safeGet(tourDetails, 'arrivalCity')} (${formatDate(safeGet(tourDetails, 'arrivalDate'))})`,
          departure: `Departure: ${safeGet(tourDetails, 'departureCity')} (${formatDate(safeGet(tourDetails, 'departureDate'))})`,
        },
        hotel: {
          guests: `${safeGet(quotationDetails, 'adults', 0)} Adults, ${safeGet(quotationDetails, 'children', 0)} Children, ${safeGet(quotationDetails, 'kids', 0)} Kids, ${safeGet(quotationDetails, 'infants', 0)} Infants`,
          rooms: `${safeGet(rooms, 'numberOfRooms', 0)} ${safeGet(rooms, 'roomType', '')} (${safeGet(rooms, 'sharingType', '')})`,
          mealPlan: safeGet(quotationDetails, 'mealPlan'),
          destination: generateDestinationText(destinations),
          itinerary: safeGet(tourDetails, 'initalNotes', 'This is only tentative schedule for sightseeing and travel...'),
        },
        vehicles: vehicleDetails.basicsDetails ? [{
          pickup: { 
            date: formatDate(safeGet(vehicleDetails, 'pickupDropDetails.pickupDate')),
            time: formatTime(safeGet(vehicleDetails, 'pickupDropDetails.pickupTime'))
          },
          drop: { 
            date: formatDate(safeGet(vehicleDetails, 'pickupDropDetails.dropDate')),
            time: formatTime(safeGet(vehicleDetails, 'pickupDropDetails.dropTime'))
          },
          vehicleType: safeGet(vehicleDetails, 'basicsDetails.vehicleType'),
          tripType: safeGet(vehicleDetails, 'basicsDetails.tripType'),
          noOfDays: safeGet(vehicleDetails, 'basicsDetails.noOfDays'),
          perDayCost: safeGet(vehicleDetails, 'basicsDetails.perDayCost'),
        }] : [],
        pricing: {
          discount: `‚Çπ ${safeGet(quotationDetails, 'discount', 0)}`,
          gst: `‚Çπ ${gstAmount.toLocaleString('en-IN')}`,
          total: `‚Çπ ${finalTotal.toLocaleString('en-IN')}`,
          roomCost: `‚Çπ ${parseFloat(roomCost).toLocaleString('en-IN')}`,
          vehicleCost: `‚Çπ ${parseFloat(vehicleCost).toLocaleString('en-IN')}`,
          totalCost: `‚Çπ ${finalTotal.toLocaleString('en-IN')}`
        },
        policies: {
          inclusions: safeGet(policies, 'inclusionPolicy', []).filter(item => item.trim() !== ''),
          exclusions: safeGet(policies, 'exclusionPolicy', []).filter(item => item.trim() !== '').join('\n'),
          paymentPolicy: safeGet(policies, 'paymentPolicy', []).filter(item => item.trim() !== '').join('\n'),
          cancellationPolicy: safeGet(policies, 'cancellationPolicy', []).filter(item => item.trim() !== '').join('\n'),
          terms: safeGet(policies, 'termsAndConditions', []).filter(item => item.trim() !== '').join('\n'),
        },
        footer: {
          contact: `${safeGet(clientDetails, 'clientName')} | +91 7053900957`,
          phone: "+91 7053900957",
          email: "support@iconicyatra.com",
          received: "‚Çπ 0",
          balance: `‚Çπ ${finalTotal.toLocaleString('en-IN')}`,
          company: "Iconic Yatra",
          address: "Office No 15, Bhawani Market Sec 27, Noida, Uttar Pradesh ‚Äì 201301",
          website: "https://www.iconicyatra.com",
        },
      });

      // Set days from itinerary
      setDays(formattedDays.length > 0 ? formattedDays : [
        { id: 1, date: new Date().toLocaleDateString(), title: "Day 1", description: "", image: null }
      ]);
    }
  }, [selectedQuotation]);

  // Helper functions
  const formatDate = (dateString) => {
    if (!dateString) return "N/A";
    try {
      return new Date(dateString).toLocaleDateString('en-IN');
    } catch {
      return "N/A";
    }
  };

  const formatTime = (dateString) => {
    if (!dateString) return "N/A";
    try {
      return new Date(dateString).toLocaleTimeString('en-IN', { 
        hour: '2-digit', 
        minute: '2-digit',
        hour12: true 
      });
    } catch {
      return "N/A";
    }
  };

  const generateDestinationText = (destinations = []) => {
    if (!destinations || destinations.length === 0) return "N/A";
    return destinations.map(dest => 
      `${safeGet(dest, 'nights', 0)}N ${safeGet(dest, 'cityName', 'Unknown')}`
    ).join(", ");
  };

  const calculateRoomCost = (destinations = [], rooms = {}) => {
    if (!destinations || destinations.length === 0) return 0;
    
    const roomType = safeGet(rooms, 'roomType', 'standard');
    let total = 0;
    
    destinations.forEach(dest => {
      const price = safeGet(dest, `prices.${roomType}`, 0);
      const nights = safeGet(dest, 'nights', 0);
      total += price * nights;
    });
    
    return total;
  };

  const generateHotelPricingData = (destinations = []) => {
    if (!destinations || destinations.length === 0) {
      return [
        {
          destination: "No destinations",
          nights: "-",
          standard: "-",
          deluxe: "-",
          superior: "-",
        }
      ];
    }

    const destinationRows = destinations.map(dest => ({
      destination: safeGet(dest, 'cityName', 'Unknown'),
      nights: `${safeGet(dest, 'nights', 0)} N`,
      standard: safeGet(dest, 'standardHotels', []).join(', ') || '-',
      deluxe: safeGet(dest, 'deluxeHotels', []).join(', ') || '-',
      superior: safeGet(dest, 'superiorHotels', []).join(', ') || '-',
    }));

    // Calculate totals
    const totalNights = destinations.reduce((sum, dest) => sum + safeGet(dest, 'nights', 0), 0);
    const standardTotal = destinations.reduce((sum, dest) => sum + (safeGet(dest, 'prices.standard', 0) * safeGet(dest, 'nights', 0)), 0);
    const deluxeTotal = destinations.reduce((sum, dest) => sum + (safeGet(dest, 'prices.deluxe', 0) * safeGet(dest, 'nights', 0)), 0);
    const superiorTotal = destinations.reduce((sum, dest) => sum + (safeGet(dest, 'prices.superior', 0) * safeGet(dest, 'nights', 0)), 0);

    return [
      ...destinationRows,
      {
        destination: "Quotation Cost",
        nights: "-",
        standard: `‚Çπ ${standardTotal.toLocaleString('en-IN')}`,
        deluxe: `‚Çπ ${deluxeTotal.toLocaleString('en-IN')}`,
        superior: `‚Çπ ${superiorTotal.toLocaleString('en-IN')}`,
      },
      {
        destination: "Total Quotation Cost",
        nights: `${totalNights} N`,
        standard: `‚Çπ ${standardTotal.toLocaleString('en-IN')}`,
        deluxe: `‚Çπ ${deluxeTotal.toLocaleString('en-IN')}`,
        superior: `‚Çπ ${superiorTotal.toLocaleString('en-IN')}`,
      }
    ];
  };

  const taxOptions = [
    { value: "gst5", label: "GST 5%", rate: 5 },
    { value: "gst18", label: "GST 18%", rate: 18 },
    { value: "non", label: "Non", rate: 0 },
  ];

  const hotelPricingData = generateHotelPricingData(safeGet(selectedQuotation, 'data.tourDetails.quotationDetails.destinations', []));

  // Show loading state
  if (loading) {
    return (
      <Box display="flex" justifyContent="center" alignItems="center" minHeight="400px">
        <CircularProgress />
        <Typography variant="h6" sx={{ ml: 2 }}>
          Loading quotation...
        </Typography>
      </Box>
    );
  }

  // Show error state
  if (error) {
    return (
      <Box display="flex" justifyContent="center" alignItems="center" minHeight="400px">
        <Alert severity="error" sx={{ width: '100%', maxWidth: 500 }}>
          <Typography variant="h6">Error loading quotation</Typography>
          <Typography>{error}</Typography>
          <Button 
            variant="contained" 
            sx={{ mt: 2 }}
            onClick={() => dispatch(getCustomQuotationById(id))}
          >
            Retry
          </Button>
        </Alert>
      </Box>
    );
  }

  // If no quotation data is available yet, show a message
  if (!selectedQuotation || !selectedQuotation.data) {
    return (
      <Box display="flex" justifyContent="center" alignItems="center" minHeight="400px">
        <Alert severity="info" sx={{ width: '100%', maxWidth: 500 }}>
          <Typography variant="h6">No quotation data available</Typography>
          <Typography>Please check if the quotation ID is correct.</Typography>
        </Alert>
      </Box>
    );
  }

  // Dialog handlers
  const handleEmailOpen = () => setOpenEmailDialog(true);
  const handleEmailClose = () => setOpenEmailDialog(false);

  const handlePaymentOpen = () => setOpenPaymentDialog(true);
  const handlePaymentClose = () => setOpenPaymentDialog(false);

  const handleFinalizeOpen = () => setOpenFinalize(true);
  const handleFinalizeClose = () => setOpenFinalize(false);

  const handleAddServiceOpen = () => setOpenAddService(true);
  const handleAddServiceClose = () => {
    setOpenAddService(false);
    setCurrentService({
      included: "yes",
      particulars: "",
      amount: "",
      taxType: "",
    });
  };

  const handleAddFlightOpen = () => setOpenAddFlight(true);
  const handleAddFlightClose = () => setOpenAddFlight(false);

  const handleEditOpen = (
    field,
    value,
    title,
    nested = false,
    nestedKey = ""
  ) => {
    setEditDialog({ open: true, field, value, title, nested, nestedKey });
  };

  const handleEditClose = () => {
    setEditDialog({
      open: false,
      field: "",
      value: "",
      title: "",
      nested: false,
      nestedKey: "",
    });
  };

  const handleEditSave = () => {
    setQuotation((prev) => ({
      ...prev,
      [editDialog.field]: editDialog.nested
        ? {
            ...prev[editDialog.field],
            [editDialog.nestedKey]: editDialog.value,
          }
        : editDialog.value,
    }));
    handleEditClose();
  };

  const handleEditValueChange = (e) => {
    setEditDialog({ ...editDialog, value: e.target.value });
  };

  const handleConfirm = () => {
    setIsFinalized(true);
    setOpenFinalize(false);
    setOpenBankDialog(true);
  };

  const handleBankDialogClose = () => {
    setOpenBankDialog(false);
    setAccountType("company");
    setAccountName("Iconic Yatra");
    setAccountNumber("");
    setIfscCode("");
    setBankName("");
    setBranchName("");
  };

  const handleBankConfirm = () => {
    console.log("Bank details:", {
      accountType,
      accountName,
      accountNumber,
      ifscCode,
      bankName,
      branchName,
    });
    setInvoiceGenerated(true);
    handleBankDialogClose();
  };

  // Add New Bank Functions
  const handleAddBankOpen = () => {
    setOpenAddBankDialog(true);
  };

  const handleAddBankClose = () => {
    setOpenAddBankDialog(false);
    setNewBankDetails({
      bankName: "",
      branchName: "",
      accountHolderName: "",
      accountNumber: "",
      ifscCode: "",
      openingBalance: "",
    });
  };

  const handleNewBankChange = (field, value) => {
    setNewBankDetails((prev) => ({
      ...prev,
      [field]: value,
    }));
  };

  const handleAddBank = () => {
    if (
      !newBankDetails.bankName ||
      !newBankDetails.accountHolderName ||
      !newBankDetails.accountNumber
    ) {
      alert("Please fill in all required fields");
      return;
    }

    const newAccount = {
      value: newBankDetails.bankName,
      label: `${newBankDetails.bankName} - ${newBankDetails.accountHolderName}`,
    };

    setAccountOptions((prev) => [...prev, newAccount]);
    setAccountName(newAccount.value);
    handleAddBankClose();
  };

  // Add Service Functions
  const handleServiceChange = (field, value) => {
    setCurrentService((prev) => ({
      ...prev,
      [field]: value,
    }));
  };

  const handleAddService = () => {
    if (
      !currentService.particulars ||
      (currentService.included === "no" && !currentService.amount)
    ) {
      alert("Please fill in all required fields");
      return;
    }

    const selectedTax = taxOptions.find(
      (option) => option.value === currentService.taxType
    );
    const taxRate = selectedTax ? selectedTax.rate : 0;

    const amount =
      currentService.included === "yes" ? 0 : parseFloat(currentService.amount);
    const taxAmount = amount * (taxRate / 100) || 0;

    const newService = {
      ...currentService,
      id: Date.now(),
      amount: amount,
      taxRate,
      taxAmount,
      totalAmount: amount + taxAmount,
      taxLabel: selectedTax ? selectedTax.label : "Non",
    };

    setServices((prev) => [...prev, newService]);
    setCurrentService({
      included: "yes",
      particulars: "",
      amount: "",
      taxType: "",
    });
  };

  const handleClearService = () => {
    setCurrentService({
      included: "yes",
      particulars: "",
      amount: "",
      taxType: "",
    });
  };

  const handleRemoveService = (id) => {
    setServices((prev) => prev.filter((service) => service.id !== id));
  };

  const handleSaveServices = () => {
    console.log("Services saved:", services);
    handleAddServiceClose();
  };

  const handleAddFlight = (flightDetails) => {
    setFlights((prev) => [...prev, { ...flightDetails, id: Date.now() }]);
    console.log("Flight added:", flightDetails);
    handleAddFlightClose();
  };

  const handleDayImageUpload = (dayId, file) => {
    if (file) {
      setDays((prev) =>
        prev.map((day) =>
          day.id === dayId
            ? {
                ...day,
                image: {
                  file,
                  preview: URL.createObjectURL(file),
                  name: file.name,
                },
              }
            : day
        )
      );
      console.log(`Image uploaded for Day ${dayId}:`, file.name);
    }
  };

  const handleAddDay = () => {
    const newDayId = days.length + 1;
    setDays((prev) => [
      ...prev,
      {
        id: newDayId,
        date: new Date().toLocaleDateString(),
        title: `Day ${newDayId}`,
        description: "",
        image: null,
      },
    ]);
  };

  const handleRemoveDay = (dayId) => {
    if (days.length > 1) {
      setDays((prev) => prev.filter((day) => day.id !== dayId));
    } else {
      alert("At least one day is required");
    }
  };

  const handlePreviewPdf = () => {
    console.log("Preview PDF clicked");
  };

  const handleViewInvoice = () => {
    console.log("View Invoice clicked");
  };

  const handleActionClick = (action) => {
    switch (action) {
      case "Finalize":
        handleFinalizeOpen();
        break;
      case "Add Service":
        handleAddServiceOpen();
        break;
      case "Email Quotation":
        handleEmailOpen();
        break;
      case "Preview PDF":
        handlePreviewPdf();
        break;
      case "Make Payment":
        handlePaymentOpen();
        break;
      case "Add Flight":
        handleAddFlightOpen();
        break;
      case "Transaction":
        setOpenTransactionDialog(true);
        break;
      default:
        console.log("Unknown action:", action);
    }
  };

  const handleAddItinerary = () => {
    const currentDays = days.length;
    setItineraryDialog({
      open: true,
      mode: 'add',
      day: currentDays + 1,
      title: `Day ${currentDays + 1}`,
      description: "",
      id: null
    });
  };

  const handleEditItinerary = (day, index) => {
    setItineraryDialog({
      open: true,
      mode: 'edit',
      day: index + 1,
      title: day.title || `Day ${index + 1}`,
      description: day.description || "",
      id: day.id
    });
  };

  const handleSaveItinerary = async () => {
    const { mode, title, description, id } = itineraryDialog;
    
    if (!title.trim() || !description.trim()) {
      setSnackbar({
        open: true,
        message: "Please fill in both title and description",
        severity: "error"
      });
      return;
    }

    try {
      if (mode === 'add') {
        const newDay = {
          id: Date.now(),
          date: new Date().toLocaleDateString(),
          title,
          description,
          image: null
        };
        
        setDays(prev => [...prev, newDay]);
      } else if (mode === 'edit') {
        setDays(prev => 
          prev.map(day => 
            day.id === id ? { ...day, title, description } : day
          )
        );
      }
      
      setItineraryDialog({ open: false, mode: 'add', day: null, title: "", description: "", id: null });
      
      setSnackbar({
        open: true,
        message: `Itinerary ${mode === 'add' ? 'added' : 'updated'} successfully`,
        severity: "success"
      });
      
    } catch (error) {
      setSnackbar({
        open: true,
        message: "Failed to save itinerary",
        severity: "error"
      });
    }
  };

  const handleCloseItineraryDialog = () => {
    setItineraryDialog({ open: false, mode: 'add', day: null, title: "", description: "", id: null });
  };

  const handleCloseSnackbar = () => {
    setSnackbar({ ...snackbar, open: false });
  };

  // UI Data
  const infoMap = {
    call: `üìû ${quotation.footer.phone}`,
    email: `‚úâÔ∏è ${quotation.footer.email}`,
    payment: `Received: ${quotation.footer.received}\n Balance: ${quotation.footer.balance}`,
    quotation: `Total Quotation Cost: ${quotation.pricing.total}`,
    guest: `No. of Guests: ${quotation.hotel.guests}`,
  };

  const infoChips = [
    { k: "call", icon: <Phone /> },
    { k: "email", icon: <AlternateEmail /> },
    { k: "payment", icon: <CreditCard /> },
    { k: "quotation", icon: <Description /> },
    { k: "guest", icon: <Person /> },
  ];

  const Accordions = [
    { title: "Hotel Details" },
    { title: "Vehicle Details" },
    { title: "Company Margin" },
    { title: "Agent Margin" },
  ];

  const Policies = [
    {
      title: "Inclusion Policy",
      icon: <CheckCircle sx={{ mr: 0.5, color: "success.main" }} />,
      content: quotation.policies.inclusions.length > 0 ? (
        <List dense>
          {quotation.policies.inclusions.map((i, k) => (
            <ListItem key={k}>
              <ListItemText primary={i} />
            </ListItem>
          ))}
        </List>
      ) : (
        <Typography variant="body2">No inclusions specified</Typography>
      ),
      field: "policies.inclusions",
      isArray: true,
    },
    {
      title: "Exclusion Policy",
      icon: <Cancel sx={{ mr: 0.5, color: "error.main" }} />,
      content: quotation.policies.exclusions || "No exclusions specified",
      field: "policies.exclusions",
    },
    {
      title: "Payment Policy",
      icon: <Payment sx={{ mr: 0.5, color: "primary.main" }} />,
      content: quotation.policies.paymentPolicy || "No payment policy specified",
      field: "policies.paymentPolicy",
    },
    {
      title: "Cancellation & Refund",
      icon: <Warning sx={{ mr: 0.5, color: "warning.main" }} />,
      content: quotation.policies.cancellationPolicy || "No cancellation policy specified",
      field: "policies.cancellationPolicy",
    },
  ];

  const pickupDetails = [
    {
      icon: (
        <CheckCircle sx={{ fontSize: 16, mr: 0.5, color: "success.main" }} />
      ),
      text: quotation.pickup.arrival,
      editable: true,
      field: "pickup",
      nestedKey: "arrival",
    },
    {
      icon: <Cancel sx={{ fontSize: 16, mr: 0.5, color: "error.main" }} />,
      text: quotation.pickup.departure,
      editable: true,
      field: "pickup",
      nestedKey: "departure",
    },
    {
      icon: <Group sx={{ fontSize: 16, mr: 0.5 }} />,
      text: `No of Guest: ${quotation.hotel.guests}`,
      editable: true,
      field: "hotel.guests",
    },
  ];

  return (
    <Box sx={{ backgroundColor: 'white', minHeight: '100vh' }}>
      {/* Action Buttons */}
      <Box
        display="flex"
        justifyContent="flex-end"
        gap={1}
        mb={2}
        flexWrap="wrap"
      >
        {quotation.actions
          .filter(
            (a) =>
              !(a === "Finalize" && isFinalized) &&
              !(a === "Transaction" && !isFinalized)
          )
          .map((a, i) => (
            <Button key={i} variant="contained" onClick={() => handleActionClick(a)}>
              {a}
            </Button>
          ))}
        {isFinalized && !invoiceGenerated && (
          <Button
            variant="contained"
            color="success"
            startIcon={<Receipt />}
            onClick={handlePreviewPdf}
          >
            Generate Invoice
          </Button>
        )}
        {invoiceGenerated && (
          <Button
            variant="contained"
            color="info"
            startIcon={<Visibility />}
            onClick={handleViewInvoice}
          >
            View Invoice
          </Button>
        )}
      </Box>

      <Grid container spacing={2}>
        {/* Sidebar */}
        <Grid size={{ xs: 12, md: 3 }}>
          <Box sx={{ position: "sticky", top: 0 }}>
            <Card>
              <CardContent>
                <Box display="flex" alignItems="center" mb={1}>
                  <Person color="primary" sx={{ mr: 1 }} />
                  <Typography variant="h6">
                    {quotation.customer.name}
                  </Typography>
                </Box>
                <Box display="flex" alignItems="center" mb={2}>
                  <LocationOn
                    sx={{ fontSize: 18, mr: 0.5, color: "text.secondary" }}
                  />
                  <Typography variant="body2" color="text.secondary">
                    {quotation.customer.location}
                  </Typography>
                </Box>
                <Box display="flex" gap={1} sx={{ flexWrap: "wrap", mb: 2 }}>
                  {infoChips.map(({ k, icon }) => (
                    <Chip
                      key={k}
                      icon={icon}
                      label={k}
                      size="small"
                      variant="outlined"
                      onClick={() => setActiveInfo(k)}
                    />
                  ))}
                </Box>
                {activeInfo && (
                  <Typography variant="body2" whiteSpace="pre-line">
                    {infoMap[activeInfo]}
                  </Typography>
                )}
                <Typography
                  variant="subtitle1"
                  fontWeight="bold"
                  color="warning.main"
                  mt={8}
                  textAlign="center"
                >
                  Margin & Taxes (B2C)
                </Typography>
                {Accordions.map((a, i) => (
                  <Accordion key={i}>
                    <AccordionSummary expandIcon={<ExpandMore />}>
                      <Typography color="primary" fontWeight="bold">
                        {a.title}
                      </Typography>
                    </AccordionSummary>
                    <AccordionDetails>
                      <Typography variant="body2">Details go here.</Typography>
                    </AccordionDetails>
                  </Accordion>
                ))}
              </CardContent>
            </Card>
          </Box>
        </Grid>

        {/* Main Content */}
        <Grid size={{ xs: 12, md: 9 }}>
          <Card>
            <CardContent>
              <Box
                display="flex"
                justifyContent="space-between"
                alignItems="center"
              >
                <Box display="flex" alignItems="center">
                  <CalendarToday sx={{ fontSize: 18, mr: 0.5 }} />
                  <Typography variant="body2" fontWeight="bold">
                    Date: {quotation.date}
                  </Typography>
                </Box>
                {isFinalized && (
                  <Typography
                    variant="h6"
                    color="success.main"
                    fontWeight="bold"
                    display="flex"
                    alignItems="center"
                  >
                    <CheckCircle sx={{ mr: 1 }} />
                    Confirmation Voucher
                  </Typography>
                )}
              </Box>

              <Box display="flex" alignItems="center" mt={1}>
                <Description sx={{ fontSize: 18, mr: 0.5 }} />
                <Typography variant="body2" fontWeight="bold">
                  Ref: {quotation.reference}
                </Typography>
              </Box>

              <Box display="flex" alignItems="center" mt={2}>
                <Person sx={{ fontSize: 18, mr: 0.5 }} />
                <Typography variant="subtitle1" fontWeight="bold">
                  Kind Attention: {quotation.customer.name}
                </Typography>
              </Box>

              {/* Pickup/Drop Details */}
              <Box
                mt={2}
                p={2}
                sx={{ backgroundColor: "grey.50", borderRadius: 1 }}
              >
                <Box
                  display="flex"
                  alignItems="center"
                  justifyContent="space-between"
                  mb={1}
                >
                  <Typography
                    variant="subtitle2"
                    fontWeight="bold"
                    display="flex"
                    alignItems="center"
                    sx={{ fontSize: "0.875rem" }}
                  >
                    <RouteIcon sx={{ mr: 0.5 }} />
                    Pickup/Drop Details
                  </Typography>
                </Box>
                {pickupDetails.map((i, k) => (
                  <Box key={k} display="flex" alignItems="center" mb={0.5}>
                    {i.icon}
                    <Typography variant="body2" sx={{ mr: 1 }}>
                      {i.text}
                    </Typography>
                    {i.editable && (
                      <IconButton
                        size="small"
                        onClick={() =>
                          handleEditOpen(
                            i.field,
                            i.text,
                            i.nestedKey || i.field,
                            !!i.nestedKey,
                            i.nestedKey
                          )
                        }
                      >
                        <Edit fontSize="small" />
                      </IconButton>
                    )}
                  </Box>
                ))}
              </Box>

              {/* Quotation Details */}
              <Box mt={3}>
                <Box display="flex" alignItems="center">
                  <FormatQuoteIcon sx={{ mr: 1 }} />
                  <Typography
                    variant="h6"
                    fontWeight="bold"
                    color="warning.main"
                  >
                    Custom Quotation For {quotation.customer.name}
                  </Typography>
                </Box>

                <Box display="flex" alignItems="center" mt={1}>
                  <Route sx={{ mr: 0.5 }} />
                  <Typography variant="subtitle2">
                    Destination : {quotation.hotel.destination}
                  </Typography>
                </Box>

                <Box display="flex" alignItems="center" mt={1}>
                  <ImageIcon sx={{ mr: 0.5 }} />
                  <Typography variant="body2" sx={{ mb: 1, fontWeight: 500 }}>
                    Add Banner Image
                  </Typography>
                  <Button component="label" sx={{ textTransform: "none" }}>
                    <AddCircleOutline />
                    <input
                      type="file"
                      hidden
                      accept="image/*"
                      onChange={(e) => {
                        const file = e.target.files[0];
                        if (file) {
                          setQuotation((prev) => ({
                            ...prev,
                            bannerImage: file.name,
                          }));
                          console.log("Selected file:", file);
                        }
                      }}
                    />
                  </Button>
                  {quotation.bannerImage && (
                    <Typography
                      variant="body2"
                      sx={{ ml: 2, fontStyle: "italic" }}
                    >
                      Selected: {quotation.bannerImage}
                    </Typography>
                  )}
                </Box>

                {/* Itinerary */}
                <Box display="flex" flexDirection="column" mt={2}>
                  <Box display="flex" alignItems="center" mb={1}>
                    <Warning sx={{ mr: 1, color: "warning.main" }} />
                    <Typography
                      variant="h6"
                      fontWeight="bold"
                      color="warning.main"
                    >
                      Day Wise Itinerary
                    </Typography>
                  </Box>
                  <Box
                    display="flex"
                    alignItems="center"
                    justifyContent="space-between"
                  >
                    <Typography variant="body2" sx={{ flex: 1, mr: 2 }}>
                      {quotation.hotel.itinerary}
                    </Typography>
                    <IconButton
                      size="small"
                      onClick={() =>
                        handleEditOpen(
                          "hotel.itinerary",
                          quotation.hotel.itinerary,
                          "Itinerary Note"
                        )
                      }
                    >
                      <Edit fontSize="small" />
                    </IconButton>
                  </Box>
                </Box>

                {/* Itinerary Days Section */}
                <Box mt={2}>
                  <Card variant="outlined">
                    <CardContent>
                      <Box display="flex" justifyContent="space-between" alignItems="center" mb={2}>
                        <Typography variant="h6">Itinerary Details</Typography>
                        <Button 
                          variant="outlined" 
                          size="small" 
                          onClick={handleAddItinerary}
                          startIcon={<Add />}
                        >
                          Add Day
                        </Button>
                      </Box>
                      
                      {days.length > 0 ? (
                        days.map((day, index) => (
                          <Box key={day.id} mb={2} p={1} sx={{ border: '1px dashed #ddd', borderRadius: 1 }}>
                            <Box display="flex" justifyContent="space-between" alignItems="flex-start">
                              <Typography variant="subtitle1" fontWeight="bold">
                                {day.title}
                              </Typography>
                              <Box>
                                <IconButton
                                  size="small"
                                  onClick={() => handleEditItinerary(day, index)}
                                >
                                  <Edit fontSize="small" />
                                </IconButton>
                                {days.length > 1 && (
                                  <IconButton
                                    size="small"
                                    color="error"
                                    onClick={() => handleRemoveDay(day.id)}
                                  >
                                    <Delete />
                                  </IconButton>
                                )}
                              </Box>
                            </Box>
                            <Typography variant="body2" sx={{ mt: 1 }}>
                              {day.description || "No description added."}
                            </Typography>
                            
                            {/* Image Section */}
                            <Box display="flex" alignItems="center" gap={2} mt={2}>
                              <ImageIcon sx={{ color: "primary.main" }} />
                              <Typography variant="body1">Add Image</Typography>
                              <Button
                                component="label"
                                variant="outlined"
                                size="small"
                                startIcon={<AddCircleOutline />}
                              >
                                Upload Image
                                <input
                                  type="file"
                                  hidden
                                  accept="image/*"
                                  onChange={(e) =>
                                    handleDayImageUpload(day.id, e.target.files[0])
                                  }
                                />
                              </Button>
                            </Box>

                            {day.image && (
                              <Box mt={2} display="flex" alignItems="center" gap={2}>
                                <Box
                                  component="img"
                                  src={day.image.preview}
                                  alt={`Day ${day.id}`}
                                  sx={{
                                    width: 100,
                                    height: 100,
                                    objectFit: "cover",
                                    borderRadius: 1,
                                    border: "1px solid #e0e0e0",
                                  }}
                                />
                                <Box>
                                  <Typography variant="body2" fontWeight="medium">
                                    {day.image.name}
                                  </Typography>
                                  <Button
                                    size="small"
                                    color="error"
                                    onClick={() => handleDayImageUpload(day.id, null)}
                                  >
                                    Remove
                                  </Button>
                                </Box>
                              </Box>
                            )}
                          </Box>
                        ))
                      ) : (
                        <Typography variant="body2" color="textSecondary" textAlign="center" py={2}>
                          No itinerary added yet. Click "Add Day" to create your itinerary.
                        </Typography>
                      )}
                    </CardContent>
                  </Card>
                </Box>
              </Box>

              {/* Quotation Details */}
              <Box display="flex" flexDirection="column" mt={2}>
                <Box display="flex" alignItems="center" mb={1}>
                  <FormatQuote sx={{ mr: 1, color: "warning.main" }} />
                  <Typography
                    variant="h6"
                    fontWeight="bold"
                    color="warning.main"
                  >
                    Quotation Details
                  </Typography>
                </Box>
                <Box>
                  <Typography variant="body2" sx={{ flex: 1, mr: 2 }}>
                    No of Guest : {quotation.hotel.guests}
                  </Typography>
                  <Typography variant="body2" sx={{ flex: 1, mr: 2 }}>
                    No of Rooms : {quotation.hotel.rooms}
                  </Typography>
                  <Typography variant="body2" sx={{ flex: 1, mr: 2 }}>
                    Meal Plan : {quotation.hotel.mealPlan}
                  </Typography>
                </Box>
              </Box>

              {/* Hotel Pricing Table */}
              <Box mt={3}>
                <TableContainer component={Paper} variant="outlined">
                  <Table>
                    <TableHead sx={{ backgroundColor: "primary.light" }}>
                      <TableRow>
                        {[
                          "Destination",
                          "Nights",
                          "Standard",
                          "Deluxe",
                          "Superior",
                        ].map((h) => (
                          <TableCell
                            key={h}
                            sx={{ color: "white", fontWeight: "bold" }}
                          >
                            {h}
                          </TableCell>
                        ))}
                      </TableRow>
                    </TableHead>
                    <TableBody>
                      {hotelPricingData.map((row, index) => (
                        <TableRow
                          key={index}
                          sx={{
                            backgroundColor:
                              index >= hotelPricingData.length - 2
                                ? "grey.50"
                                : "inherit",
                            fontWeight:
                              index === hotelPricingData.length - 1
                                ? "bold"
                                : "normal",
                          }}
                        >
                          <TableCell>{row.destination}</TableCell>
                          <TableCell>{row.nights}</TableCell>
                          <TableCell>{row.standard}</TableCell>
                          <TableCell>{row.deluxe}</TableCell>
                          <TableCell>{row.superior}</TableCell>
                        </TableRow>
                      ))}
                    </TableBody>
                  </Table>
                </TableContainer>
              </Box>

              {/* Vehicle Details */}
              {quotation.vehicles.length > 0 && (
                <Box mt={3}>
                  <Card variant="outlined">
                    <CardContent>
                      <Typography variant="h6" gutterBottom>
                        Vehicle Details
                      </Typography>
                      {quotation.vehicles.map((vehicle, index) => (
                        <Box key={index} mb={2}>
                          <Typography variant="body2">
                            <strong>Vehicle Type:</strong> {vehicle.vehicleType}
                          </Typography>
                          <Typography variant="body2">
                            <strong>Trip Type:</strong> {vehicle.tripType}
                          </Typography>
                          <Typography variant="body2">
                            <strong>No. of Days:</strong> {vehicle.noOfDays}
                          </Typography>
                          <Typography variant="body2">
                            <strong>Per Day Cost:</strong> ‚Çπ {parseFloat(vehicle.perDayCost).toLocaleString('en-IN')}
                          </Typography>
                          <Typography variant="body2">
                            <strong>Pickup:</strong> {vehicle.pickup.date} at {vehicle.pickup.time}
                          </Typography>
                          <Typography variant="body2">
                            <strong>Drop:</strong> {vehicle.drop.date} at {vehicle.drop.time}
                          </Typography>
                          <Typography variant="body2">
                            <strong>Total Vehicle Cost:</strong> {quotation.pricing.vehicleCost}
                          </Typography>
                        </Box>
                      ))}
                    </CardContent>
                  </Card>
                </Box>
              )}

              {/* Cost Summary */}
              <Box mt={3}>
                <Card variant="outlined">
                  <CardContent>
                    <Typography variant="h6" gutterBottom>
                      Cost Summary
                    </Typography>
                    <Box display="flex" justifyContent="space-between" mb={1}>
                      <Typography variant="body2">Room Cost:</Typography>
                      <Typography variant="body2">{quotation.pricing.roomCost}</Typography>
                    </Box>
                    {quotation.vehicles.length > 0 && (
                      <Box display="flex" justifyContent="space-between" mb={1}>
                        <Typography variant="body2">Vehicle Cost:</Typography>
                        <Typography variant="body2">{quotation.pricing.vehicleCost}</Typography>
                      </Box>
                    )}
                    <Box display="flex" justifyContent="space-between" mb={1}>
                      <Typography variant="body2">Discount:</Typography>
                      <Typography variant="body2">{quotation.pricing.discount}</Typography>
                    </Box>
                    <Box display="flex" justifyContent="space-between" mb={1}>
                      <Typography variant="body2">GST:</Typography>
                      <Typography variant="body2">{quotation.pricing.gst}</Typography>
                    </Box>
                    <Box display="flex" justifyContent="space-between" mb={1}>
                      <Typography variant="body1" fontWeight="bold">Total Cost:</Typography>
                      <Typography variant="body1" fontWeight="bold">{quotation.pricing.total}</Typography>
                    </Box>
                  </CardContent>
                </Card>
              </Box>

              {/* Policies */}
              <Grid container spacing={2} mt={1}>
                {Policies.map((p, i) => (
                  <Grid size={{ xs: 12 }} key={i}>
                    <Card variant="outlined">
                      <CardContent>
                        <Box
                          display="flex"
                          alignItems="center"
                          justifyContent="space-between"
                        >
                          <Typography
                            variant="subtitle2"
                            gutterBottom
                            display="flex"
                            alignItems="center"
                            sx={{ fontSize: "0.875rem" }}
                          >
                            {p.icon}
                            {p.title}
                          </Typography>
                          <IconButton
                            size="small"
                            onClick={() =>
                              handleEditOpen(
                                p.field,
                                p.isArray
                                  ? JSON.stringify(p.content)
                                  : p.content,
                                p.title
                              )
                            }
                          >
                            <Edit fontSize="small" />
                          </IconButton>
                        </Box>
                        <Typography variant="body2">{p.content}</Typography>
                      </CardContent>
                    </Card>
                  </Grid>
                ))}
              </Grid>

              {/* Terms & Conditions */}
              <Box mt={2}>
                <Card variant="outlined">
                  <CardContent>
                    <Box
                      display="flex"
                      alignItems="center"
                      justifyContent="space-between"
                    >
                      <Typography
                        variant="subtitle2"
                        gutterBottom
                        display="flex"
                        alignItems="center"
                        sx={{ fontSize: "0.875rem" }}
                      >
                        <Description sx={{ mr: 0.5 }} />
                        Terms & Condition
                      </Typography>
                      <IconButton
                        size="small"
                        onClick={() =>
                          handleEditOpen(
                            "policies.terms",
                            quotation.policies.terms,
                            "Terms & Conditions"
                          )
                        }
                      >
                        <Edit fontSize="small" />
                      </IconButton>
                    </Box>
                    <Typography variant="body2">
                      {quotation.policies.terms || "No terms and conditions specified"}
                    </Typography>
                  </CardContent>
                </Card>
              </Box>

              {/* Footer */}
              <Box
                mt={4}
                p={2}
                sx={{
                  backgroundColor: "primary.light",
                  borderRadius: 1,
                  color: "white",
                }}
              >
                <Box
                  display="flex"
                  alignItems="center"
                  justifyContent="space-between"
                >
                  <Typography variant="body2">
                    Thanks & Regards,
                    <br />
                    <Person sx={{ mr: 0.5, fontSize: 18 }} />
                    {quotation.footer.contact}
                  </Typography>
                  <IconButton
                    size="small"
                    sx={{ color: "white" }}
                    onClick={() =>
                      handleEditOpen(
                        "footer.contact",
                        quotation.footer.contact,
                        "Footer Contact",
                        false
                      )
                    }
                  >
                    <Edit fontSize="small" />
                  </IconButton>
                </Box>
                <Typography
                  variant="subtitle1"
                  sx={{ mt: 1, fontWeight: "bold" }}
                >
                  {quotation.footer.company}
                </Typography>
                <Box display="flex" alignItems="center" mt={0.5}>
                  <Business sx={{ mr: 0.5, fontSize: 18 }} />
                  {quotation.footer.address}
                </Box>
                <Box display="flex" alignItems="center" mt={0.5}>
                  <Language sx={{ mr: 0.5, fontSize: 18 }} />
                  <a
                    href={quotation.footer.website}
                    target="_blank"
                    rel="noreferrer"
                    style={{ color: "white", textDecoration: "underline" }}
                  >
                    {quotation.footer.website}
                  </a>
                  <Typography variant="subtitle1" sx={{ ml: 2 }}>
                    GST : 09EYCPK8832C1ZC
                  </Typography>
                </Box>
              </Box>
            </CardContent>
          </Card>
        </Grid>
      </Grid>

      {/* Snackbar for notifications */}
      <Snackbar 
        open={snackbar.open} 
        autoHideDuration={3000} 
        onClose={handleCloseSnackbar}
        anchorOrigin={{ vertical: 'top', horizontal: 'right' }}
      >
        <Alert onClose={handleCloseSnackbar} severity={snackbar.severity}>
          {snackbar.message}
        </Alert>
      </Snackbar>

      {/* Dialogs */}
      <FinalizeDialog
        open={openFinalize}
        onClose={handleFinalizeClose}
        vendor={vendor}
        setVendor={setVendor}
        onConfirm={handleConfirm}
      />
      <HotelVendorDialog
        open={openBankDialog}
        onClose={handleBankDialogClose}
        accountType={accountType}
        setAccountType={setAccountType}
        accountName={accountName}
        setAccountName={setAccountName}
        accountOptions={accountOptions}
        onAddBankOpen={handleAddBankOpen}
        onConfirm={handleBankConfirm}
      />
      <AddBankDialog
        open={openAddBankDialog}
        onClose={handleAddBankClose}
        newBankDetails={newBankDetails}
        onNewBankChange={handleNewBankChange}
        onAddBank={handleAddBank}
      />
      <EditDialog
        open={editDialog.open}
        onClose={handleEditClose}
        title={editDialog.title}
        value={editDialog.value}
        onValueChange={handleEditValueChange}
        onSave={handleEditSave}
      />
      <AddServiceDialog
        open={openAddService}
        onClose={handleAddServiceClose}
        currentService={currentService}
        onServiceChange={handleServiceChange}
        services={services}
        onAddService={handleAddService}
        onClearService={handleClearService}
        onRemoveService={handleRemoveService}
        onSaveServices={handleSaveServices}
        taxOptions={taxOptions}
      />
      <AddFlightDialog
        open={openAddFlight}
        onClose={handleAddFlightClose}
        onSave={handleAddFlight}
      />
      <EmailQuotationDialog
        open={openEmailDialog}
        onClose={handleEmailClose}
        customer={quotation.customer}
      />
      <MakePaymentDialog
        open={openPaymentDialog}
        onClose={handlePaymentClose}
      />
      <TransactionSummaryDialog
        open={openTransactionDialog}
        onClose={() => setOpenTransactionDialog(false)}
      />

      {/* Itinerary Dialog */}
      <Dialog open={itineraryDialog.open} onClose={handleCloseItineraryDialog} maxWidth="md" fullWidth>
        <DialogTitle>
          {itineraryDialog.mode === 'add' ? 'Add' : 'Edit'} Itinerary - Day {itineraryDialog.day}
        </DialogTitle>
        <DialogContent>
          <TextField
            autoFocus
            margin="dense"
            label="Title"
            fullWidth
            variant="outlined"
            value={itineraryDialog.title}
            onChange={(e) => setItineraryDialog({...itineraryDialog, title: e.target.value})}
            sx={{ mb: 2 }}
          />
          <TextField
            margin="dense"
            label="Description"
            fullWidth
            variant="outlined"
            multiline
            rows={4}
            value={itineraryDialog.description}
            onChange={(e) => setItineraryDialog({...itineraryDialog, description: e.target.value})}
          />
        </DialogContent>
        <DialogActions>
          <Button onClick={handleCloseItineraryDialog}>Cancel</Button>
          <Button onClick={handleSaveItinerary} variant="contained">
            {itineraryDialog.mode === 'add' ? 'Add' : 'Save'}
          </Button>
        </DialogActions>
      </Dialog>
    </Box>
  );
};

export default CustomFinalize;